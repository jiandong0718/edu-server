# 学员批量导入功能说明

## 功能概述

学员批量导入功能允许管理员通过上传 Excel 文件批量导入学员信息，支持数据验证、重复检查和错误详情反馈。

## API 接口

### 1. 下载导入模板

**接口地址**: `GET /student/import-template`

**功能**: 下载包含示例数据的 Excel 导入模板

**响应**: Excel 文件下载

### 2. 批量导入学员（增强版）

**接口地址**: `POST /student/batch-import`

**请求参数**:
- `file`: MultipartFile - Excel 文件

**响应数据**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,
    "successCount": 95,
    "failureCount": 5,
    "errors": [
      {
        "rowIndex": 3,
        "studentName": "张三",
        "errorMessage": "手机号格式错误，应为11位数字"
      }
    ]
  }
}
```

## Excel 模板字段说明

| 列序号 | 字段名称 | 是否必填 | 格式说明 | 示例 |
|--------|----------|----------|----------|------|
| 0 | 姓名 | 是 | 文本 | 张三 |
| 1 | 性别 | 是 | 男/女 | 男 |
| 2 | 出生日期 | 是 | yyyy-MM-dd | 2010-01-01 |
| 3 | 手机号 | 是 | 11位数字 | 13800138000 |
| 4 | 身份证号 | 否 | 15或18位 | 110101201001011234 |
| 5 | 就读学校 | 否 | 文本 | XX小学 |
| 6 | 年级 | 否 | 文本 | 三年级 |
| 7 | 联系人姓名 | 否 | 文本 | 张父 |
| 8 | 联系人关系 | 否 | 父亲/母亲/其他 | 父亲 |
| 9 | 联系人电话 | 否 | 11位数字 | 13900139000 |
| 10 | 地址 | 否 | 文本 | 北京市朝阳区XX街道XX号 |
| 11 | 备注 | 否 | 文本 | 示例数据 |

## 数据验证规则

### 必填字段验证
- 姓名：不能为空
- 性别：不能为空，只能是"男"或"女"
- 出生日期：不能为空，格式必须为 yyyy-MM-dd
- 手机号：不能为空，必须是11位数字

### 格式验证
- 手机号：必须符合中国手机号格式（1开头，11位数字）
- 身份证号：如果填写，必须符合中国身份证号格式（15或18位）
- 出生日期：必须是有效的日期格式
- 性别：只能是"男"或"女"
- 联系人关系：如果填写，只能是"父亲"、"母亲"或"其他"

### 重复检查
- 手机号：不能与系统中已有学员重复
- 手机号：不能在导入文件中重复
- 身份证号：不能在导入文件中重复

### 联系人验证
- 如果填写了联系人姓名，则联系人电话必填
- 联系人电话必须符合手机号格式

## 业务逻辑

### 1. 学员编号生成
- 格式：STU + 年月日 + 4位序号
- 示例：STU202401300001
- 自动生成，无需在 Excel 中填写

### 2. 默认值设置
- 学员状态：默认为"potential"（潜在学员）
- 校区ID：自动设置为当前用户所属校区

### 3. 联系人处理
- 如果填写了联系人信息，自动创建联系人记录
- 联系人关系转换：
  - "父亲" → "father"
  - "母亲" → "mother"
  - "其他" → "other"
- 自动设置为主要联系人（isPrimary=true）
- 自动开启接收通知（receiveNotify=true）

### 4. 事务处理
- 使用 @Transactional 注解确保数据一致性
- 每条记录独立处理，单条失败不影响其他记录
- 失败记录会记录详细错误信息

## 技术实现

### 依赖库
- **EasyExcel 3.3.3**: Excel 文件解析和生成
- **Hutool**: 身份证号验证工具
- **MyBatis-Plus**: 数据库操作
- **Spring Boot 3.2.x**: 框架支持

### 核心类

#### 1. StudentImportDTO
```java
// Excel 导入数据传输对象
// 使用 @ExcelProperty 注解映射 Excel 列
```

#### 2. StudentImportResultDTO
```java
// 导入结果数据传输对象
// 包含总数、成功数、失败数和错误详情
```

#### 3. StudentServiceImpl
```java
// 核心业务逻辑实现
// - batchImportStudents(): 批量导入主方法
// - validateStudentImportData(): 数据验证
// - convertToStudent(): 转换为学员实体
// - convertToContact(): 转换为联系人实体
// - downloadImportTemplate(): 生成导入模板
```

### 数据库变更
```sql
-- V1.0.10__add_student_fields.sql
ALTER TABLE stu_student ADD COLUMN id_card VARCHAR(18);
ALTER TABLE stu_student ADD COLUMN address VARCHAR(255);
CREATE INDEX idx_id_card ON stu_student(id_card);
```

## 使用流程

1. **下载模板**
   - 调用 `/student/import-template` 接口下载 Excel 模板
   - 模板包含示例数据，可参考填写

2. **填写数据**
   - 按照模板格式填写学员信息
   - 注意必填字段和格式要求
   - 确保手机号不重复

3. **上传导入**
   - 调用 `/student/batch-import` 接口上传 Excel 文件
   - 系统自动验证数据并导入

4. **查看结果**
   - 返回导入结果统计
   - 如有失败记录，查看错误详情
   - 根据错误信息修正数据后重新导入

## 错误处理

### 常见错误及解决方案

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| 姓名不能为空 | 姓名列为空 | 填写学员姓名 |
| 性别格式错误 | 性别不是"男"或"女" | 修改为"男"或"女" |
| 出生日期格式错误 | 日期格式不正确 | 使用 yyyy-MM-dd 格式 |
| 手机号格式错误 | 手机号不是11位数字 | 填写正确的11位手机号 |
| 手机号已存在于系统中 | 该手机号已被其他学员使用 | 更换手机号或检查是否重复导入 |
| 手机号在导入文件中重复 | Excel 中有多条相同手机号 | 删除重复记录 |
| 身份证号格式错误 | 身份证号不符合规范 | 填写正确的15或18位身份证号 |
| 联系人电话不能为空 | 填写了联系人姓名但未填电话 | 填写联系人电话 |

## 性能优化

1. **批量处理**: 使用 EasyExcel 流式读取，支持大文件导入
2. **内存优化**: 逐行处理数据，避免一次性加载全部数据
3. **索引优化**: 为手机号和身份证号添加索引，提高查重效率
4. **事务优化**: 单条记录独立处理，失败不影响其他记录

## 安全考虑

1. **数据隔离**: 自动设置校区ID，确保多校区数据隔离
2. **权限控制**: 需要相应权限才能执行导入操作
3. **数据验证**: 严格的数据格式和业务规则验证
4. **错误日志**: 记录导入失败的详细信息，便于追踪问题

## 扩展功能

### 未来可扩展的功能
1. 支持更多字段导入（如标签、来源等）
2. 支持导入时自动分配顾问
3. 支持导入历史记录查询
4. 支持导入失败数据的批量修正
5. 支持异步导入大批量数据
6. 支持导入进度实时查询
