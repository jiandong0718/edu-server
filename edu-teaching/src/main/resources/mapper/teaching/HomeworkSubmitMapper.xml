<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.teaching.mapper.HomeworkSubmitMapper">

    <resultMap id="HomeworkSubmitResult" type="com.edu.teaching.domain.entity.HomeworkSubmit">
        <id property="id" column="id"/>
        <result property="homeworkId" column="homework_id"/>
        <result property="studentId" column="student_id"/>
        <result property="content" column="content"/>
        <result property="attachments" column="attachments"/>
        <result property="submitTime" column="submit_time"/>
        <result property="status" column="status"/>
        <result property="score" column="score"/>
        <result property="grade" column="grade"/>
        <result property="comment" column="comment"/>
        <result property="reviewerId" column="reviewer_id"/>
        <result property="reviewTime" column="review_time"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="studentName" column="student_name"/>
        <result property="studentNo" column="student_no"/>
        <result property="homeworkTitle" column="homework_title"/>
        <result property="reviewerName" column="reviewer_name"/>
    </resultMap>

    <select id="selectSubmitPage" resultMap="HomeworkSubmitResult">
        SELECT hs.*,
               s.name as student_name,
               s.student_no,
               h.title as homework_title,
               u.real_name as reviewer_name
        FROM tch_homework_submit hs
        LEFT JOIN stu_student s ON hs.student_id = s.id
        LEFT JOIN tch_homework h ON hs.homework_id = h.id
        LEFT JOIN sys_user u ON hs.reviewer_id = u.id
        WHERE hs.deleted = 0
        <if test="query.homeworkId != null">
            AND hs.homework_id = #{query.homeworkId}
        </if>
        <if test="query.studentId != null">
            AND hs.student_id = #{query.studentId}
        </if>
        <if test="query.status != null and query.status != ''">
            AND hs.status = #{query.status}
        </if>
        ORDER BY hs.submit_time DESC
    </select>

    <select id="selectByHomeworkId" resultMap="HomeworkSubmitResult">
        SELECT hs.*,
               s.name as student_name,
               s.student_no,
               u.real_name as reviewer_name
        FROM tch_homework_submit hs
        LEFT JOIN stu_student s ON hs.student_id = s.id
        LEFT JOIN sys_user u ON hs.reviewer_id = u.id
        WHERE hs.deleted = 0
          AND hs.homework_id = #{homeworkId}
        ORDER BY hs.submit_time DESC
    </select>

    <select id="selectByStudentId" resultMap="HomeworkSubmitResult">
        SELECT hs.*,
               h.title as homework_title
        FROM tch_homework_submit hs
        LEFT JOIN tch_homework h ON hs.homework_id = h.id
        WHERE hs.deleted = 0
          AND hs.student_id = #{studentId}
        <if test="classId != null">
            AND h.class_id = #{classId}
        </if>
        ORDER BY hs.submit_time DESC
    </select>

</mapper>
