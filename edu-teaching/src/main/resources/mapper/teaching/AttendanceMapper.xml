<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.teaching.mapper.AttendanceMapper">

    <resultMap id="AttendanceResult" type="com.edu.teaching.domain.entity.Attendance">
        <id property="id" column="id"/>
        <result property="scheduleId" column="schedule_id"/>
        <result property="studentId" column="student_id"/>
        <result property="classId" column="class_id"/>
        <result property="status" column="status"/>
        <result property="signTime" column="sign_time"/>
        <result property="classHours" column="class_hours"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="studentName" column="student_name"/>
        <result property="studentNo" column="student_no"/>
        <result property="courseName" column="course_name"/>
        <result property="className" column="class_name"/>
        <result property="teacherName" column="teacher_name"/>
    </resultMap>

    <select id="selectAttendancePage" resultMap="AttendanceResult">
        SELECT a.*,
               s.name as student_name,
               s.student_no,
               co.name as course_name,
               cl.name as class_name,
               t.name as teacher_name
        FROM tch_attendance a
        LEFT JOIN stu_student s ON a.student_id = s.id
        LEFT JOIN tch_schedule sc ON a.schedule_id = sc.id
        LEFT JOIN tch_course co ON sc.course_id = co.id
        LEFT JOIN tch_class cl ON sc.class_id = cl.id
        LEFT JOIN tch_teacher t ON sc.teacher_id = t.id
        WHERE a.deleted = 0
        <if test="query.scheduleId != null">
            AND a.schedule_id = #{query.scheduleId}
        </if>
        <if test="query.studentId != null">
            AND a.student_id = #{query.studentId}
        </if>
        <if test="query.status != null and query.status != ''">
            AND a.status = #{query.status}
        </if>
        ORDER BY a.create_time DESC
    </select>

    <select id="selectByScheduleId" resultMap="AttendanceResult">
        SELECT a.*,
               s.name as student_name,
               s.student_no
        FROM tch_attendance a
        LEFT JOIN stu_student s ON a.student_id = s.id
        WHERE a.deleted = 0
          AND a.schedule_id = #{scheduleId}
        ORDER BY s.student_no
    </select>

    <select id="selectByStudentId" resultMap="AttendanceResult">
        SELECT a.*,
               co.name as course_name,
               cl.name as class_name,
               t.name as teacher_name
        FROM tch_attendance a
        LEFT JOIN tch_schedule sc ON a.schedule_id = sc.id
        LEFT JOIN tch_course co ON sc.course_id = co.id
        LEFT JOIN tch_class cl ON sc.class_id = cl.id
        LEFT JOIN tch_teacher t ON sc.teacher_id = t.id
        WHERE a.deleted = 0
          AND a.student_id = #{studentId}
        <if test="startDate != null">
            AND sc.schedule_date >= #{startDate}
        </if>
        <if test="endDate != null">
            AND sc.schedule_date &lt;= #{endDate}
        </if>
        ORDER BY sc.schedule_date DESC, sc.start_time DESC
    </select>

    <select id="selectAttendanceStats" resultMap="AttendanceResult">
        SELECT a.*
        FROM tch_attendance a
        LEFT JOIN tch_schedule sc ON a.schedule_id = sc.id
        WHERE a.deleted = 0
        <if test="studentId != null">
            AND a.student_id = #{studentId}
        </if>
        <if test="classId != null">
            AND sc.class_id = #{classId}
        </if>
        <if test="startDate != null">
            AND sc.schedule_date >= #{startDate}
        </if>
        <if test="endDate != null">
            AND sc.schedule_date &lt;= #{endDate}
        </if>
    </select>

</mapper>
