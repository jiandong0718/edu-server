<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.finance.mapper.RefundMapper">

    <resultMap id="RefundResult" type="com.edu.finance.domain.entity.Refund">
        <id property="id" column="id"/>
        <result property="refundNo" column="refund_no"/>
        <result property="contractId" column="contract_id"/>
        <result property="contractNo" column="contract_no"/>
        <result property="studentId" column="student_id"/>
        <result property="studentName" column="student_name"/>
        <result property="campusId" column="campus_id"/>
        <result property="campusName" column="campus_name"/>
        <result property="applyAmount" column="apply_amount"/>
        <result property="actualAmount" column="actual_amount"/>
        <result property="penaltyAmount" column="penalty_amount"/>
        <result property="reason" column="reason"/>
        <result property="description" column="description"/>
        <result property="status" column="status"/>
        <result property="applyTime" column="apply_time"/>
        <result property="approverId" column="approver_id"/>
        <result property="approverName" column="approver_name"/>
        <result property="approveTime" column="approve_time"/>
        <result property="approveRemark" column="approve_remark"/>
        <result property="refundTime" column="refund_time"/>
        <result property="refundMethod" column="refund_method"/>
        <result property="refundTransactionNo" column="refund_transaction_no"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <select id="selectRefundPage" resultMap="RefundResult">
        SELECT r.*,
               s.name as student_name,
               c.contract_no as contract_no,
               ca.name as campus_name,
               u.real_name as approver_name
        FROM fin_refund r
        LEFT JOIN stu_student s ON r.student_id = s.id
        LEFT JOIN fin_contract c ON r.contract_id = c.id
        LEFT JOIN sys_campus ca ON r.campus_id = ca.id
        LEFT JOIN sys_user u ON r.approver_id = u.id
        WHERE r.deleted = 0
        <if test="query.refundNo != null and query.refundNo != ''">
            AND r.refund_no LIKE CONCAT('%', #{query.refundNo}, '%')
        </if>
        <if test="query.contractId != null">
            AND r.contract_id = #{query.contractId}
        </if>
        <if test="query.studentId != null">
            AND r.student_id = #{query.studentId}
        </if>
        <if test="query.campusId != null">
            AND r.campus_id = #{query.campusId}
        </if>
        <if test="query.status != null and query.status != ''">
            AND r.status = #{query.status}
        </if>
        ORDER BY r.create_time DESC
    </select>

</mapper>
