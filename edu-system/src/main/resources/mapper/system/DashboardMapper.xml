<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.system.mapper.DashboardMapper">

    <!-- ========== 学员统计 ========== -->

    <select id="countStudents" resultType="int">
        SELECT COUNT(*)
        FROM stu_student
        WHERE deleted = 0
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="countStudentsByStatus" resultType="int">
        SELECT COUNT(*)
        FROM stu_student
        WHERE deleted = 0
          AND status = #{status}
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="countNewStudentsThisMonth" resultType="int">
        SELECT COUNT(*)
        FROM stu_student
        WHERE deleted = 0
          AND DATE_FORMAT(create_time, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="getStudentStatusDistribution" resultType="map">
        SELECT status as name, COUNT(*) as value
        FROM stu_student
        WHERE deleted = 0
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
        GROUP BY status
    </select>

    <!-- ========== 财务统计 ========== -->

    <select id="sumIncomeToday" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(amount), 0)
        FROM fin_payment
        WHERE deleted = 0
          AND status = 'paid'
          AND DATE(pay_time) = CURDATE()
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="sumIncomeThisWeek" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(amount), 0)
        FROM fin_payment
        WHERE deleted = 0
          AND status = 'paid'
          AND YEARWEEK(pay_time, 1) = YEARWEEK(NOW(), 1)
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="sumIncomeThisMonth" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(amount), 0)
        FROM fin_payment
        WHERE deleted = 0
          AND status = 'paid'
          AND DATE_FORMAT(pay_time, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="sumIncomeThisYear" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(amount), 0)
        FROM fin_payment
        WHERE deleted = 0
          AND status = 'paid'
          AND YEAR(pay_time) = YEAR(NOW())
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="sumRefundThisMonth" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(refund_amount), 0)
        FROM fin_refund
        WHERE deleted = 0
          AND status = 'completed'
          AND DATE_FORMAT(complete_time, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="sumPendingAmount" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(paid_amount - received_amount), 0)
        FROM fin_contract
        WHERE deleted = 0
          AND status IN ('pending', 'signed')
          AND paid_amount > received_amount
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="sumOverdueAmount" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(paid_amount - received_amount), 0)
        FROM fin_contract
        WHERE deleted = 0
          AND status IN ('pending', 'signed')
          AND paid_amount > received_amount
          AND expire_date &lt; CURDATE()
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="countContracts" resultType="int">
        SELECT COUNT(*)
        FROM fin_contract
        WHERE deleted = 0
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="getPaymentMethodDistribution" resultType="map">
        SELECT payment_method as name, COUNT(*) as count, COALESCE(SUM(amount), 0) as amount
        FROM fin_payment
        WHERE deleted = 0
          AND status = 'paid'
          AND DATE_FORMAT(pay_time, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
        GROUP BY payment_method
        ORDER BY amount DESC
    </select>

    <select id="getIncomeTrend" resultType="map">
        SELECT DATE(pay_time) as date, COALESCE(SUM(amount), 0) as amount
        FROM fin_payment
        WHERE deleted = 0
          AND status = 'paid'
          AND pay_time >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
        GROUP BY DATE(pay_time)
        ORDER BY date
    </select>

    <!-- ========== 教学统计 ========== -->

    <select id="countSchedulesByDate" resultType="int">
        SELECT COUNT(*)
        FROM tch_schedule
        WHERE deleted = 0
          AND schedule_date = #{date}
          AND status != 'cancelled'
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="countSchedulesByDateRange" resultType="int">
        SELECT COUNT(*)
        FROM tch_schedule
        WHERE deleted = 0
          AND schedule_date BETWEEN #{startDate} AND #{endDate}
          AND status != 'cancelled'
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="countClasses" resultType="int">
        SELECT COUNT(*)
        FROM tch_class
        WHERE deleted = 0
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="countClassesByStatus" resultType="int">
        SELECT COUNT(*)
        FROM tch_class
        WHERE deleted = 0
          AND status = #{status}
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="countTeachers" resultType="int">
        SELECT COUNT(*)
        FROM tch_teacher
        WHERE deleted = 0
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="countTeachersByStatus" resultType="int">
        SELECT COUNT(*)
        FROM tch_teacher
        WHERE deleted = 0
          AND status = #{status}
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="countCourses" resultType="int">
        SELECT COUNT(*)
        FROM tch_course
        WHERE deleted = 0
          AND status = 'active'
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="calculateAttendanceRate" resultType="java.lang.Double">
        SELECT
            CASE
                WHEN COUNT(*) = 0 THEN 0
                ELSE SUM(CASE WHEN a.status IN ('present', 'late') THEN 1 ELSE 0 END) * 100.0 / COUNT(*)
            END
        FROM tch_attendance a
        INNER JOIN tch_schedule s ON a.schedule_id = s.id
        WHERE a.deleted = 0
          AND s.schedule_date BETWEEN #{startDate} AND #{endDate}
        <if test="campusId != null">
            AND s.campus_id = #{campusId}
        </if>
    </select>

    <!-- ========== 营销统计 ========== -->

    <select id="countLeads" resultType="int">
        SELECT COUNT(*)
        FROM mkt_lead
        WHERE deleted = 0
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="countLeadsByStatus" resultType="int">
        SELECT COUNT(*)
        FROM mkt_lead
        WHERE deleted = 0
          AND status = #{status}
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="countNewLeadsThisMonth" resultType="int">
        SELECT COUNT(*)
        FROM mkt_lead
        WHERE deleted = 0
          AND DATE_FORMAT(create_time, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="countConvertedThisMonth" resultType="int">
        SELECT COUNT(*)
        FROM mkt_lead
        WHERE deleted = 0
          AND status = 'converted'
          AND DATE_FORMAT(update_time, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="countTrials" resultType="int">
        SELECT COUNT(*)
        FROM mkt_trial_lesson
        WHERE deleted = 0
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="countTrialsThisMonth" resultType="int">
        SELECT COUNT(*)
        FROM mkt_trial_lesson
        WHERE deleted = 0
          AND DATE_FORMAT(trial_date, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="countTrialConverted" resultType="int">
        SELECT COUNT(*)
        FROM mkt_trial_lesson
        WHERE deleted = 0
          AND status = 'converted'
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <select id="getLeadSourceDistribution" resultType="map">
        SELECT source as name, COUNT(*) as value
        FROM mkt_lead
        WHERE deleted = 0
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
        GROUP BY source
        ORDER BY value DESC
    </select>

    <select id="getLeadTrend" resultType="map">
        SELECT DATE(create_time) as date, COUNT(*) as count
        FROM mkt_lead
        WHERE deleted = 0
          AND create_time >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
        GROUP BY DATE(create_time)
        ORDER BY date
    </select>

    <select id="getConversionTrend" resultType="map">
        SELECT DATE(update_time) as date, COUNT(*) as count
        FROM mkt_lead
        WHERE deleted = 0
          AND status = 'converted'
          AND update_time >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
        GROUP BY DATE(update_time)
        ORDER BY date
    </select>

</mapper>
