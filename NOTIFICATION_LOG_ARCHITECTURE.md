# 通知发送记录功能架构图

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  Web前端     │  │  移动端      │  │  第三方系统   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Controller层                                │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │        NotificationLogController                          │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │  │
│  │  │ 分页查询    │  │ 详情查询    │  │ 统计查询    │      │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘      │  │
│  │  ┌─────────────┐  ┌─────────────┐                        │  │
│  │  │ 单条重发    │  │ 批量重发    │                        │  │
│  │  └─────────────┘  └─────────────┘                        │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Service层                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │        NotificationLogServiceImpl                         │  │
│  │  ┌─────────────────────────────────────────────────────┐ │  │
│  │  │  业务逻辑处理                                        │ │  │
│  │  │  - 参数校验                                          │ │  │
│  │  │  - 状态检查                                          │ │  │
│  │  │  - 重试次数限制                                      │ │  │
│  │  │  - 统计数据计算                                      │ │  │
│  │  │  - 异步重发调度                                      │ │  │
│  │  └─────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Mapper层                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │        NotificationLogMapper                              │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │  │
│  │  │ 分页查询SQL │  │ 详情查询SQL │  │ 总体统计SQL │      │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘      │  │
│  │  ┌─────────────┐  ┌─────────────┐                        │  │
│  │  │ 类型统计SQL │  │ 日期统计SQL │                        │  │
│  │  └─────────────┘  └─────────────┘                        │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据库层                                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              sys_notification_log                         │  │
│  │  ┌─────────────────────────────────────────────────────┐ │  │
│  │  │  字段: id, notification_id, type, receiver,         │ │  │
│  │  │        status, send_time, fail_reason,              │ │  │
│  │  │        retry_count, campus_id, etc.                 │ │  │
│  │  └─────────────────────────────────────────────────────┘ │  │
│  │  ┌─────────────────────────────────────────────────────┐ │  │
│  │  │  索引: type, status, send_time, campus_id, etc.    │ │  │
│  │  └─────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 数据流向

### 1. 查询流程
```
客户端请求
    ↓
Controller接收参数
    ↓
Service处理业务逻辑
    ↓
Mapper执行SQL查询
    ↓
数据库返回结果
    ↓
Service封装VO对象
    ↓
Controller返回响应
    ↓
客户端接收数据
```

### 2. 重发流程
```
客户端发起重发请求
    ↓
Controller接收请求
    ↓
Service校验状态和重试次数
    ↓
Service更新状态为"sending"
    ↓
Service异步调用发送服务 (@Async)
    ↓
发送服务执行实际发送
    ↓
更新发送结果和状态
    ↓
记录发送日志
```

### 3. 统计流程
```
客户端请求统计数据
    ↓
Controller接收参数（日期范围、校区）
    ↓
Service并行执行多个统计查询
    ├─→ 总体统计（总数、成功数、失败数）
    ├─→ 按类型统计（sms、site、email等）
    └─→ 按日期统计（每天的发送情况）
    ↓
Service计算成功率
    ↓
Service封装统计VO对象
    ↓
Controller返回统计结果
```

## 核心类关系

```
┌──────────────────────────────────────────────────────────┐
│                    Entity层                               │
│  ┌────────────────────────────────────────────────────┐  │
│  │  NotificationLog (实体类)                          │  │
│  │  - 映射到 sys_notification_log 表                  │  │
│  │  - 继承 BaseEntity                                 │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
                        │
                        ▼
┌──────────────────────────────────────────────────────────┐
│                    DTO层                                  │
│  ┌────────────────────────────────────────────────────┐  │
│  │  NotificationLogQueryDTO (查询条件)                │  │
│  │  BatchResendDTO (批量重发请求)                     │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
                        │
                        ▼
┌──────────────────────────────────────────────────────────┐
│                    VO层                                   │
│  ┌────────────────────────────────────────────────────┐  │
│  │  NotificationLogVO (发送记录详情)                  │  │
│  │  NotificationStatisticsVO (统计数据)               │  │
│  │  BatchResendResultVO (批量重发结果)                │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

## 技术栈

```
┌─────────────────────────────────────────────────────────┐
│  Spring Boot 3.2.x                                      │
│  ├─ Spring MVC (RESTful API)                           │
│  ├─ Spring Transaction (事务管理)                      │
│  └─ Spring Async (异步执行)                            │
└─────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────┐
│  MyBatis-Plus 3.5.x                                     │
│  ├─ BaseMapper (基础CRUD)                              │
│  ├─ IPage (分页查询)                                   │
│  └─ 自定义SQL (复杂查询)                               │
└─────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────┐
│  Knife4j (API文档)                                      │
│  ├─ @Tag (控制器标注)                                  │
│  ├─ @Operation (接口标注)                              │
│  └─ @Parameter (参数标注)                              │
└─────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────┐
│  Lombok (代码简化)                                      │
│  ├─ @Data (getter/setter)                              │
│  ├─ @Builder (构建器模式)                              │
│  └─ @RequiredArgsConstructor (构造注入)                │
└─────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────┐
│  MySQL 8.0+ (数据库)                                    │
│  └─ Flyway (数据库迁移)                                │
└─────────────────────────────────────────────────────────┘
```

## 文件组织结构

```
edu-notification/
├── src/main/java/com/edu/notification/
│   ├── controller/
│   │   └── NotificationLogController.java          (5个API接口)
│   ├── service/
│   │   ├── NotificationLogService.java             (服务接口)
│   │   └── impl/
│   │       └── NotificationLogServiceImpl.java     (服务实现)
│   ├── mapper/
│   │   └── NotificationLogMapper.java              (Mapper接口)
│   └── domain/
│       ├── entity/
│       │   └── NotificationLog.java                (实体类)
│       ├── dto/
│       │   ├── NotificationLogQueryDTO.java        (查询DTO)
│       │   └── BatchResendDTO.java                 (批量重发DTO)
│       └── vo/
│           ├── NotificationLogVO.java              (记录VO)
│           ├── NotificationStatisticsVO.java       (统计VO)
│           └── BatchResendResultVO.java            (批量结果VO)
└── src/main/resources/
    └── mapper/notification/
        └── NotificationLogMapper.xml               (SQL映射文件)

edu-admin/
└── src/main/resources/db/migration/
    └── V1.0.22__add_notification_log_table.sql     (数据库迁移)
```

## 关键特性

### 1. 分页查询
- 支持多条件组合查询
- 支持模糊搜索
- 支持日期范围筛选
- 自动关联校区表

### 2. 统计分析
- 总体统计（总数、成功率）
- 按类型统计（各渠道发送情况）
- 按日期统计（时间趋势分析）
- 支持校区维度筛选

### 3. 重发机制
- 状态校验（只能重发失败记录）
- 重试次数限制（最多3次）
- 异步执行（不阻塞主线程）
- 批量操作（支持部分成功）

### 4. 数据安全
- 逻辑删除（deleted字段）
- 事务保证（@Transactional）
- 参数校验（业务规则）
- 异常处理（BusinessException）
