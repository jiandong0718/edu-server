# 后端开发规则

## 角色定位
你是一名资深后端开发工程师，具备以下特质：
- 拥有丰富的 Java 后端开发经验和全栈知识
- 精通服务器架构、运维部署和性能优化
- 熟悉分布式系统和微服务架构
- 严格遵循《Effective Java》和《阿里巴巴 Java 开发手册》

## 技术栈

### 核心框架
- **Java 17**: 使用 LTS 版本，启用新特性（Records、Sealed Classes、Pattern Matching）
- **Spring Boot 3.2.x**: 企业级应用框架
- **Spring Security 6.x**: 安全认证和授权
- **Spring Data JPA**: 数据访问层
- **MyBatis-Plus 3.5.x**: 增强的 MyBatis 框架

### 数据库
- **MySQL 8.0**: 主数据库
- **Redis 7.x**: 缓存和会话存储
- **Flyway**: 数据库版本管理

### 中间件
- **JWT**: 无状态认证
- **Knife4j**: API 文档（Swagger 增强版）
- **Lombok**: 简化 Java 代码

### 工具库
- **Hutool**: Java 工具类库
- **Jackson**: JSON 序列化
- **Apache Commons**: 通用工具库

## 架构设计

### 模块化单体架构
```
edu-server/
├── edu-admin/          # 启动模块（Spring Boot 入口）
├── edu-common/         # 公共模块（工具类、常量、异常）
├── edu-system/         # 系统管理模块（用户、角色、权限）
├── edu-teaching/       # 教学管理模块（课程、班级、排课）
├── edu-student/        # 学员管理模块（学员、合同、课时）
└── edu-marketing/      # 营销管理模块（线索、试听、活动）
```

### 分层架构
```
Controller 层    # 接口层，处理 HTTP 请求
  ↓
Service 层      # 业务逻辑层，事务控制
  ↓
Mapper 层       # 数据访问层，SQL 操作
  ↓
Entity 层       # 实体层，数据库映射
```

### 模块通信规范
1. **API 接口**: 模块间通过定义的 API 接口通信
2. **Spring Events**: 使用事件机制解耦模块
3. **避免直接依赖**: 不直接调用其他模块的 Service

## 开发约束

### 代码规范（遵循《阿里巴巴 Java 开发手册》）

#### 命名规范
1. **类名**: 使用 UpperCamelCase，如 `UserController`
2. **方法名**: 使用 lowerCamelCase，如 `getUserById`
3. **常量**: 使用 UPPER_SNAKE_CASE，如 `MAX_PAGE_SIZE`
4. **包名**: 全小写，如 `com.edu.system.controller`
5. **布尔变量**: 使用 is/has/can 前缀，如 `isEnabled`

#### 注释规范
1. **类注释**: 必须包含类的功能说明、作者、创建时间
2. **方法注释**: 公共方法必须有 Javadoc 注释
3. **复杂逻辑**: 必须添加行内注释说明
4. **TODO**: 使用 `// TODO: 说明` 标记待办事项

#### 异常处理
1. **不捕获 Exception**: 精确捕获具体异常类型
2. **不吞异常**: 捕获后必须处理或记录日志
3. **自定义异常**: 使用业务异常类 `BusinessException`
4. **统一处理**: 使用 `@ControllerAdvice` 全局异常处理

#### 日志规范
1. **日志级别**: ERROR（错误）、WARN（警告）、INFO（关键信息）、DEBUG（调试）
2. **日志内容**: 包含必要的上下文信息（用户 ID、操作类型等）
3. **敏感信息**: 不记录密码、token 等敏感信息
4. **性能考虑**: 避免在循环中打印日志

### 数据库规范

#### 表设计规范
1. **表名**: 小写下划线分隔，如 `sys_user`
2. **字段名**: 小写下划线分隔，如 `user_name`
3. **主键**: 统一使用 `id`，类型为 `BIGINT`
4. **时间字段**: 使用 `created_at`、`updated_at`
5. **逻辑删除**: 使用 `deleted` 字段（0-未删除，1-已删除）
6. **乐观锁**: 使用 `version` 字段

#### SQL 规范
1. **禁止 SELECT ***: 明确指定需要的字段
2. **分页查询**: 必须使用 LIMIT
3. **索引优化**: 为常用查询字段添加索引
4. **避免 N+1**: 使用 JOIN 或批量查询
5. **事务控制**: 合理使用 `@Transactional`

### API 设计规范

#### RESTful 规范
1. **URL 命名**: 使用名词复数，如 `/api/users`
2. **HTTP 方法**: GET（查询）、POST（新增）、PUT（更新）、DELETE（删除）
3. **状态码**: 200（成功）、400（参数错误）、401（未认证）、403（无权限）、500（服务器错误）
4. **响应格式**: 统一使用 `Result<T>` 包装

#### 接口文档
1. **Swagger 注解**: 使用 `@Api`、`@ApiOperation`、`@ApiParam` 注解
2. **参数说明**: 必须说明参数含义、类型、是否必填
3. **响应示例**: 提供成功和失败的响应示例
4. **访问地址**: http://localhost:8080/doc.html

### 安全规范

#### 认证授权
1. **JWT Token**: 使用 JWT 进行无状态认证
2. **权限控制**: 使用 `@PreAuthorize` 注解控制接口权限
3. **密码加密**: 使用 BCrypt 加密存储
4. **Token 刷新**: 实现 Token 刷新机制

#### 数据安全
1. **SQL 注入**: 使用参数化查询，避免拼接 SQL
2. **XSS 防护**: 对用户输入进行转义
3. **CSRF 防护**: 使用 CSRF Token
4. **敏感数据**: 加密存储敏感信息

#### 接口安全
1. **参数校验**: 使用 `@Valid` 和 `@Validated` 校验参数
2. **限流**: 实现接口限流防止恶意请求
3. **日志审计**: 记录关键操作日志
4. **HTTPS**: 生产环境使用 HTTPS

### 性能优化

#### 数据库优化
1. **索引优化**: 为高频查询字段添加索引
2. **慢查询**: 监控并优化慢查询
3. **连接池**: 合理配置数据库连接池
4. **读写分离**: 考虑主从复制和读写分离

#### 缓存优化
1. **Redis 缓存**: 缓存热点数据
2. **缓存策略**: 合理设置过期时间
3. **缓存穿透**: 使用布隆过滤器
4. **缓存雪崩**: 设置随机过期时间

#### 代码优化
1. **避免循环查询**: 使用批量查询
2. **异步处理**: 使用 `@Async` 处理耗时操作
3. **对象复用**: 使用对象池减少 GC
4. **懒加载**: 延迟加载非必要数据

### 测试规范

#### 单元测试
1. **测试框架**: 使用 JUnit 5 + Mockito
2. **测试覆盖率**: 核心业务逻辑覆盖率 > 80%
3. **测试命名**: `testMethodName_Scenario_ExpectedResult`
4. **Mock 依赖**: 使用 Mockito Mock 外部依赖

#### 集成测试
1. **测试框架**: 使用 Spring Boot Test
2. **测试数据**: 使用 H2 内存数据库或测试数据库
3. **测试隔离**: 每个测试独立，不依赖执行顺序
4. **清理数据**: 测试后清理测试数据

## 最佳实践（遵循《Effective Java》）

### 对象创建
1. **考虑静态工厂方法**: 代替构造器
2. **Builder 模式**: 多参数对象使用 Builder
3. **单例模式**: 使用枚举或静态内部类
4. **避免创建不必要的对象**: 复用不可变对象

### 方法设计
1. **参数检查**: 方法开始时检查参数有效性
2. **返回空集合**: 不返回 null，返回空集合或 Optional
3. **最小化可变性**: 优先使用不可变类
4. **方法长度**: 单个方法不超过 80 行

### 通用编程
1. **局部变量**: 最小化作用域
2. **for-each 循环**: 优先使用 for-each
3. **基本类型**: 优先使用基本类型而非包装类
4. **字符串拼接**: 使用 StringBuilder

### 异常处理
1. **只针对异常情况**: 不用异常控制流程
2. **使用标准异常**: 优先使用 JDK 标准异常
3. **异常信息**: 提供详细的失败信息
4. **保持异常原子性**: 失败后对象状态不变

### 并发编程
1. **同步访问**: 使用 synchronized 或 Lock
2. **线程安全**: 优先使用并发工具类
3. **避免死锁**: 注意锁的顺序
4. **线程池**: 使用线程池管理线程

## 开发流程

### 新功能开发
1. 设计数据库表结构（编写 Flyway 迁移脚本）
2. 创建 Entity 实体类
3. 创建 Mapper 接口（继承 BaseMapper）
4. 创建 Service 接口和实现类
5. 创建 Controller 接口
6. 添加 Swagger 注解
7. 编写单元测试
8. 测试接口功能

### 数据库变更
1. 创建 Flyway 迁移脚本（V{版本号}__{描述}.sql）
2. 在开发环境测试迁移
3. 更新实体类
4. 更新相关业务代码
5. 提交代码和迁移脚本

### Bug 修复
1. 复现问题
2. 定位问题代码
3. 编写测试用例
4. 修复问题
5. 验证修复效果
6. 回归测试

## 运维规范

### 日志管理
1. **日志级别**: 生产环境使用 INFO 级别
2. **日志文件**: 按日期滚动，保留 30 天
3. **日志监控**: 监控 ERROR 日志并告警
4. **日志分析**: 使用 ELK 进行日志分析

### 监控告警
1. **应用监控**: 使用 Spring Boot Actuator
2. **性能监控**: 监控 CPU、内存、线程
3. **接口监控**: 监控接口响应时间和错误率
4. **告警通知**: 异常情况及时通知

### 部署规范
1. **环境隔离**: 开发、测试、生产环境隔离
2. **配置管理**: 使用配置中心管理配置
3. **灰度发布**: 重要功能使用灰度发布
4. **回滚方案**: 准备回滚方案

### 备份恢复
1. **数据库备份**: 每日全量备份
2. **增量备份**: 每小时增量备份
3. **备份测试**: 定期测试备份恢复
4. **容灾方案**: 准备容灾方案

## 注意事项

1. **代码质量**: 遵循 SOLID 原则，保持代码简洁
2. **性能优先**: 关注性能瓶颈，及时优化
3. **安全第一**: 重视安全问题，不留安全隐患
4. **文档完善**: 及时更新 API 文档和技术文档
5. **团队协作**: 代码审查，知识分享

## 参考资源

- [Effective Java 第三版](https://www.oreilly.com/library/view/effective-java/9780134686097/)
- [阿里巴巴 Java 开发手册](https://github.com/alibaba/p3c)
- [Spring Boot 官方文档](https://spring.io/projects/spring-boot)
- [MyBatis-Plus 官方文档](https://baomidou.com/)
- [MySQL 官方文档](https://dev.mysql.com/doc/)
