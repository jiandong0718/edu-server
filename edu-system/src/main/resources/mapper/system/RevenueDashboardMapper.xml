<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.system.mapper.RevenueDashboardMapper">

    <!-- 统计今日收入 -->
    <select id="sumIncomeToday" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(amount), 0)
        FROM fin_payment
        WHERE deleted = 0
          AND status = 'paid'
          AND DATE(pay_time) = CURDATE()
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <!-- 统计本周收入 -->
    <select id="sumIncomeThisWeek" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(amount), 0)
        FROM fin_payment
        WHERE deleted = 0
          AND status = 'paid'
          AND YEARWEEK(pay_time, 1) = YEARWEEK(NOW(), 1)
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <!-- 统计本月收入 -->
    <select id="sumIncomeThisMonth" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(amount), 0)
        FROM fin_payment
        WHERE deleted = 0
          AND status = 'paid'
          AND DATE_FORMAT(pay_time, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <!-- 统计本年收入 -->
    <select id="sumIncomeThisYear" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(amount), 0)
        FROM fin_payment
        WHERE deleted = 0
          AND status = 'paid'
          AND YEAR(pay_time) = YEAR(NOW())
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <!-- 统计总欠费金额 -->
    <select id="sumTotalArrears" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(paid_amount - received_amount), 0)
        FROM fin_contract
        WHERE deleted = 0
          AND status IN ('signed', 'pending')
          AND paid_amount > received_amount
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <!-- 统计欠费人数 -->
    <select id="countArrearsStudents" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT student_id)
        FROM fin_contract
        WHERE deleted = 0
          AND status IN ('signed', 'pending')
          AND paid_amount > received_amount
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <!-- 统计欠费合同数 -->
    <select id="countArrearsContracts" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM fin_contract
        WHERE deleted = 0
          AND status IN ('signed', 'pending')
          AND paid_amount > received_amount
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <!-- 统计本月退费金额 -->
    <select id="sumRefundThisMonth" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(actual_amount), 0)
        FROM fin_refund
        WHERE deleted = 0
          AND status = 'refunded'
          AND DATE_FORMAT(refund_time, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
    </select>

    <!-- 获取营收趋势（按日期） -->
    <select id="getRevenueTrend" resultType="com.edu.system.domain.vo.RevenueDashboardVO$RevenueTrendItem">
        SELECT
            DATE(pay_time) as date,
            COALESCE(SUM(amount), 0) as amount
        FROM fin_payment
        WHERE deleted = 0
          AND status = 'paid'
          AND pay_time >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
        GROUP BY DATE(pay_time)
        ORDER BY date
    </select>

    <!-- 获取收款方式分布 -->
    <select id="getPaymentMethodDistribution" resultType="com.edu.system.domain.vo.RevenueDashboardVO$PaymentMethodItem">
        SELECT
            payment_method as method,
            CASE payment_method
                WHEN 'wechat' THEN '微信'
                WHEN 'alipay' THEN '支付宝'
                WHEN 'unionpay' THEN '银联'
                WHEN 'cash' THEN '现金'
                WHEN 'pos' THEN 'POS机'
                ELSE payment_method
            END as methodName,
            COALESCE(SUM(amount), 0) as amount,
            COUNT(*) as count
        FROM fin_payment
        WHERE deleted = 0
          AND status = 'paid'
          AND DATE(pay_time) BETWEEN #{startDate} AND #{endDate}
        <if test="campusId != null">
            AND campus_id = #{campusId}
        </if>
        GROUP BY payment_method
        ORDER BY amount DESC
    </select>

    <!-- 获取欠费统计列表 -->
    <select id="getArrearsList" resultType="com.edu.system.domain.vo.RevenueDashboardVO$ArrearsItem">
        SELECT
            c.student_id as studentId,
            s.name as studentName,
            c.contract_no as contractNo,
            c.id as contractId,
            c.paid_amount as paidAmount,
            c.received_amount as receivedAmount,
            (c.paid_amount - c.received_amount) as arrearsAmount,
            sc.name as campusName,
            DATE_FORMAT(c.sign_date, '%Y-%m-%d') as signDate,
            DATE_FORMAT(c.expire_date, '%Y-%m-%d') as expireDate
        FROM fin_contract c
        LEFT JOIN stu_student s ON c.student_id = s.id
        LEFT JOIN sys_campus sc ON c.campus_id = sc.id
        WHERE c.deleted = 0
          AND c.status IN ('signed', 'pending')
          AND c.paid_amount > c.received_amount
        <if test="campusId != null">
            AND c.campus_id = #{campusId}
        </if>
        ORDER BY arrearsAmount DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 获取课程营收排行 -->
    <select id="getCourseRevenueRanking" resultType="com.edu.system.domain.vo.RevenueDashboardVO$CourseRevenueItem">
        SELECT
            ci.course_id as courseId,
            ci.course_name as courseName,
            COALESCE(SUM(ci.amount), 0) as revenue,
            COUNT(DISTINCT ci.contract_id) as contractCount,
            COUNT(DISTINCT c.student_id) as studentCount
        FROM fin_contract_item ci
        INNER JOIN fin_contract c ON ci.contract_id = c.id
        INNER JOIN fin_payment p ON c.id = p.contract_id
        WHERE c.deleted = 0
          AND p.deleted = 0
          AND p.status = 'paid'
          AND DATE(p.pay_time) BETWEEN #{startDate} AND #{endDate}
        <if test="campusId != null">
            AND c.campus_id = #{campusId}
        </if>
        GROUP BY ci.course_id, ci.course_name
        ORDER BY revenue DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

</mapper>
