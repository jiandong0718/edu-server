<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.teaching.mapper.ScheduleMapper">

    <resultMap id="ScheduleResult" type="com.edu.teaching.domain.entity.Schedule">
        <id property="id" column="id"/>
        <result property="classId" column="class_id"/>
        <result property="className" column="class_name"/>
        <result property="courseId" column="course_id"/>
        <result property="courseName" column="course_name"/>
        <result property="teacherId" column="teacher_id"/>
        <result property="teacherName" column="teacher_name"/>
        <result property="classroomId" column="classroom_id"/>
        <result property="classroomName" column="classroom_name"/>
        <result property="campusId" column="campus_id"/>
        <result property="scheduleDate" column="schedule_date"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="classHours" column="class_hours"/>
        <result property="status" column="status"/>
        <result property="lessonNo" column="lesson_no"/>
        <result property="topic" column="topic"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <select id="selectScheduleList" resultMap="ScheduleResult">
        SELECT s.*,
               c.name as class_name,
               co.name as course_name,
               t.name as teacher_name,
               cr.name as classroom_name
        FROM tch_schedule s
        LEFT JOIN tch_class c ON s.class_id = c.id
        LEFT JOIN tch_course co ON s.course_id = co.id
        LEFT JOIN tch_teacher t ON s.teacher_id = t.id
        LEFT JOIN sys_classroom cr ON s.classroom_id = cr.id
        WHERE s.deleted = 0
          AND s.schedule_date BETWEEN #{startDate} AND #{endDate}
        <if test="campusId != null">
            AND s.campus_id = #{campusId}
        </if>
        <if test="teacherId != null">
            AND s.teacher_id = #{teacherId}
        </if>
        <if test="classId != null">
            AND s.class_id = #{classId}
        </if>
        <if test="classroomId != null">
            AND s.classroom_id = #{classroomId}
        </if>
        ORDER BY s.schedule_date, s.start_time
    </select>

    <select id="checkConflict" resultType="int">
        SELECT COUNT(*)
        FROM tch_schedule
        WHERE deleted = 0
          AND status != 'cancelled'
          AND schedule_date = #{scheduleDate}
          AND (
            (teacher_id = #{teacherId} AND #{teacherId} IS NOT NULL)
            OR (classroom_id = #{classroomId} AND #{classroomId} IS NOT NULL)
          )
          AND (
            (start_time &lt; #{endTime} AND end_time &gt; #{startTime})
          )
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <select id="selectTeacherConflicts" resultMap="ScheduleResult">
        SELECT s.*,
               c.name as class_name,
               co.name as course_name,
               t.name as teacher_name,
               cr.name as classroom_name
        FROM tch_schedule s
        LEFT JOIN tch_class c ON s.class_id = c.id
        LEFT JOIN tch_course co ON s.course_id = co.id
        LEFT JOIN tch_teacher t ON s.teacher_id = t.id
        LEFT JOIN sys_classroom cr ON s.classroom_id = cr.id
        WHERE s.deleted = 0
          AND s.status != 'cancelled'
          AND s.schedule_date = #{scheduleDate}
          AND s.teacher_id = #{teacherId}
          AND s.start_time &lt; #{endTime}
          AND s.end_time &gt; #{startTime}
        <if test="excludeId != null">
            AND s.id != #{excludeId}
        </if>
        ORDER BY s.start_time
    </select>

    <select id="selectClassroomConflicts" resultMap="ScheduleResult">
        SELECT s.*,
               c.name as class_name,
               co.name as course_name,
               t.name as teacher_name,
               cr.name as classroom_name
        FROM tch_schedule s
        LEFT JOIN tch_class c ON s.class_id = c.id
        LEFT JOIN tch_course co ON s.course_id = co.id
        LEFT JOIN tch_teacher t ON s.teacher_id = t.id
        LEFT JOIN sys_classroom cr ON s.classroom_id = cr.id
        WHERE s.deleted = 0
          AND s.status != 'cancelled'
          AND s.schedule_date = #{scheduleDate}
          AND s.classroom_id = #{classroomId}
          AND s.start_time &lt; #{endTime}
          AND s.end_time &gt; #{startTime}
        <if test="excludeId != null">
            AND s.id != #{excludeId}
        </if>
        ORDER BY s.start_time
    </select>

    <select id="selectStudentConflictSchedules" resultMap="ScheduleResult">
        SELECT DISTINCT s.*,
               c.name as class_name,
               co.name as course_name,
               t.name as teacher_name,
               cr.name as classroom_name
        FROM tch_schedule s
        INNER JOIN tch_class_student cs ON s.class_id = cs.class_id
        INNER JOIN (
            SELECT student_id
            FROM tch_class_student
            WHERE class_id = #{classId}
              AND status = 'active'
              AND deleted = 0
        ) target_students ON cs.student_id = target_students.student_id
        LEFT JOIN tch_class c ON s.class_id = c.id
        LEFT JOIN tch_course co ON s.course_id = co.id
        LEFT JOIN tch_teacher t ON s.teacher_id = t.id
        LEFT JOIN sys_classroom cr ON s.classroom_id = cr.id
        WHERE s.deleted = 0
          AND s.status != 'cancelled'
          AND s.schedule_date = #{scheduleDate}
          AND s.start_time &lt; #{endTime}
          AND s.end_time &gt; #{startTime}
          AND cs.status = 'active'
          AND cs.deleted = 0
          AND s.class_id != #{classId}
        <if test="excludeId != null">
            AND s.id != #{excludeId}
        </if>
        ORDER BY s.start_time
    </select>

</mapper>
