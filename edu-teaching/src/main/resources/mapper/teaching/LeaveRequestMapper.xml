<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.teaching.mapper.LeaveRequestMapper">

    <resultMap id="LeaveRequestResult" type="com.edu.teaching.domain.entity.LeaveRequest">
        <id property="id" column="id"/>
        <result property="leaveNo" column="leave_no"/>
        <result property="studentId" column="student_id"/>
        <result property="scheduleId" column="schedule_id"/>
        <result property="classId" column="class_id"/>
        <result property="campusId" column="campus_id"/>
        <result property="type" column="type"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="reason" column="reason"/>
        <result property="status" column="status"/>
        <result property="approverId" column="approver_id"/>
        <result property="approveTime" column="approve_time"/>
        <result property="approveRemark" column="approve_remark"/>
        <result property="needMakeup" column="need_makeup"/>
        <result property="makeupScheduleId" column="makeup_schedule_id"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="studentName" column="student_name"/>
        <result property="studentNo" column="student_no"/>
        <result property="className" column="class_name"/>
        <result property="approverName" column="approver_name"/>
    </resultMap>

    <select id="selectLeaveRequestPage" resultMap="LeaveRequestResult">
        SELECT lr.*,
               s.name as student_name,
               s.student_no,
               cl.name as class_name,
               u.real_name as approver_name
        FROM tch_leave_request lr
        LEFT JOIN stu_student s ON lr.student_id = s.id
        LEFT JOIN tch_class cl ON lr.class_id = cl.id
        LEFT JOIN sys_user u ON lr.approver_id = u.id
        WHERE lr.deleted = 0
        <if test="query.studentId != null">
            AND lr.student_id = #{query.studentId}
        </if>
        <if test="query.classId != null">
            AND lr.class_id = #{query.classId}
        </if>
        <if test="query.campusId != null">
            AND lr.campus_id = #{query.campusId}
        </if>
        <if test="query.status != null and query.status != ''">
            AND lr.status = #{query.status}
        </if>
        <if test="query.type != null and query.type != ''">
            AND lr.type = #{query.type}
        </if>
        ORDER BY lr.create_time DESC
    </select>

</mapper>
